{% schema %}
{
  "name": "Space Particles Flow",
  "settings": [
    {
      "type": "color",
      "id": "bg_color",
      "label": "Barva pozadí",
      "default": "#050510"
    },
    {
      "type": "color",
      "id": "particle_color",
      "label": "Barva hvězd",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "particle_count",
      "min": 50,
      "max": 500,
      "step": 10,
      "label": "Počet hvězd",
      "default": 200
    },
    {
      "type": "range",
      "id": "flow_speed",
      "min": 1,
      "max": 20,
      "step": 1,
      "label": "Rychlost letu",
      "default": 3
    },
    {
      "type": "range",
      "id": "height",
      "min": 200,
      "max": 900,
      "step": 50,
      "unit": "px",
      "label": "Výška sekce",
      "default": 500
    },
    {
        "type": "header",
        "content": "Obsah"
    },
    {
        "type": "text",
        "id": "heading",
        "label": "Nadpis",
        "default": "Galaxy Flow"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Barva textu",
      "default": "#ffffff"
    }
  ],
  "presets": [
    {
      "name": "Space Particles Flow"
    }
  ]
}
{% endschema %}

<div class="space-container" style="background-color: {{ section.settings.bg_color }}; height: {{ section.settings.height }}px;">
  <canvas id="space-canvas-{{ section.id }}"></canvas>
  
  {% if section.settings.heading != blank %}
    <div class="space-content" style="color: {{ section.settings.text_color }};">
        <h1>{{ section.settings.heading }}</h1>
    </div>
  {% endif %}
</div>

<style>
  .space-container {
    position: relative;
    width: 100%;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .space-container canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  .space-content {
    position: relative;
    z-index: 2;
    text-align: center;
    pointer-events: none;
    padding: 20px;
  }
  
  .space-content h1 {
    font-size: 3.5rem;
    font-weight: 800;
    letter-spacing: 2px;
    margin: 0;
    text-shadow: 0 0 20px rgba(255,255,255,0.3);
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const canvas = document.getElementById('space-canvas-{{ section.id }}');
    const ctx = canvas.getContext('2d');
    
    let width, height;
    
    // Nastavení
    const particleColorHex = "{{ section.settings.particle_color }}";
    const particleCount = {{ section.settings.particle_count }};
    // Rychlost převedeme na desetinné číslo pro jemný pohyb
    const globalSpeed = {{ section.settings.flow_speed }} * 0.1; 
    
    function hexToRgb(hex) {
        hex = hex.replace(/^#/, '');
        let bigint = parseInt(hex, 16);
        let r = (bigint >> 16) & 255;
        let g = (bigint >> 8) & 255;
        let b = bigint & 255;
        return `${r},${g},${b}`;
    }
    const particleColorRGB = hexToRgb(particleColorHex);

    let particlesArray = [];
    
    let mouse = {
        x: null,
        y: null,
        radius: 120
    }

    function resize() {
        width = canvas.parentElement.clientWidth;
        height = canvas.parentElement.clientHeight;
        canvas.width = width;
        canvas.height = height;
    }
    resize();

    canvas.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect();
        mouse.x = e.clientX - rect.left;
        mouse.y = e.clientY - rect.top;
    });
    
    canvas.addEventListener('mouseleave', () => {
        mouse.x = null;
        mouse.y = null;
    });

    class Particle {
        constructor() {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.size = Math.random() * 2 + 0.5; // Velikost hvězd
            
            // Rychlost závisí na velikosti (Parallax efekt - větší jsou "blíž" a letí rychleji)
            // Přidáme náhodnou odchylku, ale držíme směr doprava a mírně nahoru/dolů
            this.speedX = (Math.random() * 0.5 + 0.2) * globalSpeed * this.size; 
            this.speedY = (Math.random() * 0.2 - 0.1) * globalSpeed * this.size; // Mírný vertikální drift
            
            this.opacity = Math.random() * 0.8 + 0.1;
        }

        draw() {
            ctx.fillStyle = `rgba(${particleColorRGB}, ${this.opacity})`;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.closePath();
            ctx.fill();
        }

        update() {
            // 1. Základní pohyb (Flow)
            this.x += this.speedX;
            this.y += this.speedY;

            // 2. Interakce s myší (Odpuzování)
            if (mouse.x != null) {
                let dx = mouse.x - this.x;
                let dy = mouse.y - this.y;
                let distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < mouse.radius) {
                    const forceDirectionX = dx / distance;
                    const forceDirectionY = dy / distance;
                    const force = (mouse.radius - distance) / mouse.radius;
                    
                    // Jemné odtlačení
                    this.x -= forceDirectionX * force * 2;
                    this.y -= forceDirectionY * force * 2;
                }
            }

            // 3. Nekonečná smyčka (Space wrapping)
            // Pokud vyletí doprava, vrátí se vlevo
            if (this.x > width) {
                this.x = 0;
                this.y = Math.random() * height; // Náhodná výška pro variabilitu
            }
            // Pokud vyletí doleva (pro jistotu)
            if (this.x < 0) this.x = width;
            
            // Vertikální wrap
            if (this.y > height) this.y = 0;
            if (this.y < 0) this.y = height;

            this.draw();
        }
    }

    function init() {
        particlesArray = [];
        for (let i = 0; i < particleCount; i++) {
            particlesArray.push(new Particle());
        }
    }

    function animate() {
        // Tady děláme trik pro "šmouhy" (Motion trails)
        // Místo clearRect kreslíme poloprůhledný obdélník.
        // Pro ostré hvězdy použij clearRect. Pro vesmírný flow je lepší toto:
        ctx.clearRect(0, 0, width, height); 
        
        for (let i = 0; i < particlesArray.length; i++) {
            particlesArray[i].update();
        }
        requestAnimationFrame(animate);
    }

    init();
    animate();

    window.addEventListener('resize', () => {
        resize();
        init();
    });
});
</script>
